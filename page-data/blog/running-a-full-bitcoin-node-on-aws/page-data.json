{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/running-a-full-bitcoin-node-on-aws/","result":{"data":{"site":{"siteMetadata":{"title":"Peter Halliday","siteUrl":"https://pghalliday.com/portfolio"}},"markdownRemark":{"id":"961bcf08-e127-5e59-9170-4e45a177aca0","excerpt":"UPDATE - 10th August 2014: The results are in The node stayed stable throughout July and the free tier benefits ran out before that so the following is the…","html":"<h1>UPDATE - 10th August 2014: The results are in</h1>\n<p>The node stayed stable throughout July and the free tier benefits ran out before that so the following is the complete cost.</p>\n<p>Total incl. VAT @ 20%: <strong>$42.06</strong></p>\n<p>The main contributions to this were (incl. VAT @ 20%):</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Data Transfer</th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">$0.120 per GB - up to 10 TB / month data transfer out</td>\n<td>135.096 GB</td>\n<td>$19.46</td>\n</tr>\n</tbody>\n</table>\n<br>\n<table>\n<thead>\n<tr>\n<th align=\"left\">EC2</th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">$0.020 per On Demand Linux t1.micro Instance Hour</td>\n<td>744 Hrs</td>\n<td>$17.86</td>\n</tr>\n<tr>\n<td align=\"left\">$0.05 per 1 million I/O requests - US East (Northern Virginia)</td>\n<td>23,715,799 IOs</td>\n<td>$1.43</td>\n</tr>\n<tr>\n<td align=\"left\">$0.05 per GB-month of Magnetic provisioned storage - US East (Northern Virginia)</td>\n<td>48.000 GB-Mo</td>\n<td>$2.88</td>\n</tr>\n</tbody>\n</table>\n<br>\n<hr>\n<p>I just want to know how much it will cost to run a full bitcoin node on an EC2 instance. The two main factors being disk usage (the size of the block chain at the time of writing being around 17GB) and IO (how much traffic I may have to pay for to allow incoming connections on port 8333).</p>\n<ol>\n<li>I start with a t1.micro instance running Ubuntu 14.04 (LTS) 64 bit.</li>\n<li>For now I accept the default 8GB root volume and add an additional 40GB EBS volume on which I’ll store the blockchain (Originally I started with 20GB but this did not last long before running out of space and crashing the node - i’m sure less would suffice for a while but i don’t want to resize the disk again every few days/weeks)</li>\n<li>I configure any IP access on port 22 for SSH (I have to be able to configure my server - although I could restrict the IP addresses allowed to connect on this port for added security)</li>\n<li>I configure any IP access on port 8333 (I want this to be a useful node and not a leech! So other nodes have to be able to connect)</li>\n<li>I create a new key pair to access the server using SSH and launch the instance!</li>\n</ol>\n<p>Next I have to connect and install/configure bitcoind. To simplify things I’ll add a <code class=\"language-text\">~/.ssh/config</code> file to point to my new key and awkward public DNS name</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Host bitcoin-node\n    HostName ec2-XXX-XXX-XXX-XXX.compute-1.amazonaws.com\n    User ubuntu\n    IdentityFile ~/.ssh/bitcoin-node.pem</code></pre></div>\n<p>This allows me to connect with a simple <code class=\"language-text\">ssh bitcoin-node</code></p>\n<p>So, now to install <code class=\"language-text\">bitcoind</code>…</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> add-apt-repository ppa:bitcoin/bitcoin\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> bitcoind</code></pre></div>\n<p>And configure it as a service…</p>\n<p>Before I start the <code class=\"language-text\">bitcoind</code> service I want to configure it to use my EBS volume for the blockchain. The first step of which is to initialize and mount the volume. Run the following command to get the device name</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># lsblk</span>\nNAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nxvdb  <span class=\"token number\">202</span>:16   <span class=\"token number\">0</span>  40G  <span class=\"token number\">0</span> disk \nxvda1 <span class=\"token number\">202</span>:1    <span class=\"token number\">0</span>   8G  <span class=\"token number\">0</span> disk /</code></pre></div>\n<p>As you can see, in my case I have an unitialized volume at <code class=\"language-text\">/dev/xvdb</code> (<code class=\"language-text\">lsblk</code> strips the <code class=\"language-text\">/dev/</code> from the device name). So I use the following command to initialize an <code class=\"language-text\">ext4</code> filesystem</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">mkfs</span> -t ext4 /dev/xvdb</code></pre></div>\n<p>Next, I need to configure this to be mounted on boot. First I will create a mount point</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /data</code></pre></div>\n<p>Then we can add the following line to <code class=\"language-text\">/etc/fstab</code> to mount the volume on boot in future</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/dev/xvdb       /data   ext4    defaults        0       2</code></pre></div>\n<p>Run the following to mount the volumes listed in <code class=\"language-text\">/etc/fstab</code></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> -a</code></pre></div>\n<p>Now add a <code class=\"language-text\">bitcoin</code> system user, setting its home directory on the EBS volume</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> adduser --system --group --shell /bin/bash --home /data/bitcoin bitcoin</code></pre></div>\n<p>To configure <code class=\"language-text\">bitcoind</code> we now need to add a config file to <code class=\"language-text\">/data/bitcoin/.bitcoin/bitcoin.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">rpcuser=bitcoinrpc\nrpcpassword=DO_NOT_USE_THIS_PASSWORD_MAKE_UP_SOMETHING_RANDOM_YOU_DONT_HAVE_TO_REMEMBER_IT</code></pre></div>\n<p>Now set the permissions on it</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> bitcoin:bitcoin /data/bitcoin/.bitcoin/bitcoin.conf\n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> 0600 /data/bitcoin/.bitcoin/bitcoin.conf</code></pre></div>\n<p>Now we can add an upstart config at <code class=\"language-text\">/etc/init/bitcoind.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">description &quot;bitcoind&quot;\n\nstart on filesystem\nstop on runlevel [!2345]\noom never\nexpect daemon\nrespawn\nrespawn limit 10 60 # 10 times in 60 seconds\n\nscript\nuser=bitcoin\nhome=/data/bitcoin\ncmd=/usr/bin/bitcoind\npidfile=$home/bitcoind.pid\n# Don&#39;t change anything below here unless you know what you&#39;re doing\n[[ -e $pidfile &amp;&amp; ! -d &quot;/proc/$(cat $pidfile)&quot; ]] &amp;&amp; rm $pidfile\n[[ -e $pidfile &amp;&amp; &quot;$(cat /proc/$(cat $pidfile)/cmdline)&quot; != $cmd* ]] &amp;&amp; rm $pidfile\nexec start-stop-daemon --start -c $user --chdir $home --pidfile $pidfile --startas $cmd -b --nicelevel 15 -m\nend script</code></pre></div>\n<p>Before we can start the service we need to make sure that the machine does not run out of memory and crash it. This will happen after a fairly short time. The solution is to add a swapfile.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>/dev/zero <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>/swapfile <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>1M <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span><span class=\"token number\">1536</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">mkswap</span> /swapfile\n<span class=\"token function\">sudo</span> <span class=\"token function\">swapon</span> /swapfile</code></pre></div>\n<p>This creates a 1.5GB (a little over twice the RAM of 0.613GB on a t1.micro instance) swap file and activates it. In order to ensure it is activated on reboot we need to add another entry to <code class=\"language-text\">/etc/fstab</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/swapfile       none    swap    sw      0       0 </code></pre></div>\n<p>To ensure that the swapfile is only used when it’s really needed we should set the swappiness. This is an optimization of the kernel. A high value (maximum of 100) would tell the kernel to favour the swap file, we will set a low value of 10 to favour RAM when it is available.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">echo</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /proc/sys/vm/swappiness\n<span class=\"token builtin class-name\">echo</span> vm.swappiness <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> -a /etc/sysctl.conf</code></pre></div>\n<p>These commands set the current swappiness value and set the kernel configuration to the same value on reboot. To finish configuring the swapfile, set its permissions so that it cannot be read by other users.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> root:root /swapfile \n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> 0600 /swapfile</code></pre></div>\n<p>Only now should we register the service and start it…</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> initctl reload-configuration\n<span class=\"token function\">sudo</span> start bitcoind</code></pre></div>\n<p>And there we go, the bitcoin node should be running and downloading the blockchain. I have no intention of actually using it as a wallet but hopefully it will be providing the useful services of a participating full node. Now let’s see how the costs stack up.</p>","frontmatter":{"disqus_identifier":"running-a-full-bitcoin-node-on-aws","title":"Running a full Bitcoin node on AWS","date":"May 02, 2014","description":null},"fields":{"slug":"/blog/running-a-full-bitcoin-node-on-aws/"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/running-a-full-bitcoin-node-on-aws/","previous":{"fields":{"slug":"/blog/nodejs--getting-test-coverage-from-child-processes/"},"frontmatter":{"title":"NodeJS - Getting test coverage from child processes"}},"next":{"fields":{"slug":"/blog/auto-build-and-deploy-github-pages-with-travis-ci/"},"frontmatter":{"title":"Auto build and deploy GitHub pages with Travis-CI"}}}}}